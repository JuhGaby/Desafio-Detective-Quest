#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// Defini√ß√£o da estrutura da sala
typedef struct Sala {
    char nome[50];
    char pista[100];  // Pista associada √† sala
    struct Sala *esquerda;
    struct Sala *direita;
} Sala;

// Defini√ß√£o da estrutura para a √°rvore BST de pistas
typedef struct PistaNode {
    char pista[100];
    struct PistaNode *esquerda;
    struct PistaNode *direita;
} PistaNode;

/**
 * Fun√ß√£o: criarSala
 * Prop√≥sito: Cria uma nova sala dinamicamente com nome e pista
 * Par√¢metros: 
 *   - nome: string com o nome da sala
 *   - pista: string com a pista da sala (pode ser vazia)
 * Retorno: Ponteiro para a sala criada
 */
Sala* criarSala(const char* nome, const char* pista) {
    Sala* novaSala = (Sala*)malloc(sizeof(Sala));
    if (novaSala == NULL) {
        printf("Erro: Mem√≥ria insuficiente!\n");
        exit(1);
    }
    
    strcpy(novaSala->nome, nome);
    strcpy(novaSala->pista, pista);
    novaSala->esquerda = NULL;
    novaSala->direita = NULL;
    
    return novaSala;
}

/**
 * Fun√ß√£o: criarNoPista
 * Prop√≥sito: Cria um novo n√≥ para a √°rvore BST de pistas
 * Par√¢metros: pista - string com o conte√∫do da pista
 * Retorno: Ponteiro para o n√≥ de pista criado
 */
PistaNode* criarNoPista(const char* pista) {
    PistaNode* novoNo = (PistaNode*)malloc(sizeof(PistaNode));
    if (novoNo == NULL) {
        printf("Erro: Mem√≥ria insuficiente!\n");
        exit(1);
    }
    
    strcpy(novoNo->pista, pista);
    novoNo->esquerda = NULL;
    novoNo->direita = NULL;
    
    return novoNo;
}

/**
 * Fun√ß√£o: inserirPista
 * Prop√≥sito: Insere uma nova pista na √°rvore BST em ordem alfab√©tica
 * Par√¢metros: 
 *   - raiz: ponteiro para a raiz da √°rvore de pistas
 *   - pista: string com a pista a ser inserida
 * Retorno: Ponteiro para a raiz atualizada da √°rvore
 */
PistaNode* inserirPista(PistaNode* raiz, const char* pista) {
    // Se a √°rvore est√° vazia, cria o n√≥ raiz
    if (raiz == NULL) {
        return criarNoPista(pista);
    }
    
    // Compara as pistas para decidir se vai para esquerda ou direita
    int comparacao = strcmp(pista, raiz->pista);
    
    if (comparacao < 0) {
        // Pista menor - vai para a esquerda
        raiz->esquerda = inserirPista(raiz->esquerda, pista);
    } else if (comparacao > 0) {
        // Pista maior - vai para a direita
        raiz->direita = inserirPista(raiz->direita, pista);
    }
    // Se as pistas forem iguais, n√£o insere duplicatas
    
    return raiz;
}

/**
 * Fun√ß√£o: exibirPistas
 * Prop√≥sito: Exibe todas as pistas coletadas em ordem alfab√©tica (percurso in-order)
 * Par√¢metros: raiz - ponteiro para a raiz da √°rvore de pistas
 */
void exibirPistas(PistaNode* raiz) {
    if (raiz != NULL) {
        // Percorre a √°rvore em ordem: esquerda -> raiz -> direita
        exibirPistas(raiz->esquerda);
        printf("‚Ä¢ %s\n", raiz->pista);
        exibirPistas(raiz->direita);
    }
}

/**
 * Fun√ß√£o: explorarSalasComPistas
 * Prop√≥sito: Controla a navega√ß√£o entre salas e coleta de pistas
 * Par√¢metros:
 *   - salaAtual: ponteiro para a sala atual na explora√ß√£o
 *   - arvorePistas: ponteiro para o ponteiro da √°rvore de pistas (para poder modificar)
 */
void explorarSalasComPistas(Sala* salaAtual, PistaNode** arvorePistas) {
    char opcao;
    
    printf("\n=== DETECTIVE QUEST - SISTEMA DE PISTAS ===\n");
    printf("Voc√™ est√° na: %s\n", salaAtual->nome);
    
    // Verifica se h√° pista nesta sala e se ainda n√£o foi coletada
    if (strlen(salaAtual->pista) > 0) {
        printf("\nüîç PISTA ENCONTRADA: \"%s\"\n", salaAtual->pista);
        
        // Adiciona a pista √† √°rvore BST
        *arvorePistas = inserirPista(*arvorePistas, salaAtual->pista);
        printf("Pista adicionada ao seu caderno de investiga√ß√£o!\n");
        
        // Marca a pista como coletada (limpando a string da pista)
        strcpy(salaAtual->pista, "");
    }
    
    // Mostra op√ß√µes de navega√ß√£o
    printf("\nOp√ß√µes de explora√ß√£o:\n");
    if (salaAtual->esquerda != NULL) {
        printf("[e] Ir para a ESQUERDA -> %s\n", salaAtual->esquerda->nome);
    }
    if (salaAtual->direita != NULL) {
        printf("[d] Ir para a DIREITA -> %s\n", salaAtual->direita->nome);
    }
    printf("[s] SAIR da explora√ß√£o e ver pistas coletadas\n");
    
    // Loop para obter uma op√ß√£o v√°lida
    while (1) {
        printf("\nEscolha uma op√ß√£o: ");
        scanf(" %c", &opcao);
        
        switch (opcao) {
            case 'e':
            case 'E':
                if (salaAtual->esquerda != NULL) {
                    explorarSalasComPistas(salaAtual->esquerda, arvorePistas);
                    return;
                } else {
                    printf("N√£o h√° caminho √† esquerda!\n");
                }
                break;
                
            case 'd':
            case 'D':
                if (salaAtual->direita != NULL) {
                    explorarSalasComPistas(salaAtual->direita, arvorePistas);
                    return;
                } else {
                    printf("N√£o h√° caminho √† direita!\n");
                }
                break;
                
            case 's':
            case 'S':
                printf("Saindo da explora√ß√£o...\n");
                return;
                
            default:
                printf("Op√ß√£o inv√°lida! Use 'e', 'd' ou 's'.\n");
                break;
        }
    }
}

/**
 * Fun√ß√£o: liberarArvoreSalas
 * Prop√≥sito: Libera toda a mem√≥ria alocada para a √°rvore de salas
 * Par√¢metros: raiz - ponteiro para a raiz da √°rvore de salas
 */
void liberarArvoreSalas(Sala* raiz) {
    if (raiz != NULL) {
        liberarArvoreSalas(raiz->esquerda);
        liberarArvoreSalas(raiz->direita);
        free(raiz);
    }
}

/**
 * Fun√ß√£o: liberarArvorePistas
 * Prop√≥sito: Libera toda a mem√≥ria alocada para a √°rvore de pistas
 * Par√¢metros: raiz - ponteiro para a raiz da √°rvore de pistas
 */
void liberarArvorePistas(PistaNode* raiz) {
    if (raiz != NULL) {
        liberarArvorePistas(raiz->esquerda);
        liberarArvorePistas(raiz->direita);
        free(raiz);
    }
}

/**
 * Fun√ß√£o: main
 * Prop√≥sito: Monta o mapa inicial da mans√£o com pistas e inicia a explora√ß√£o
 */
int main() {
    // Cria√ß√£o do mapa da mans√£o (√°rvore bin√°ria) com pistas
    printf("=== INICIALIZANDO DETECTIVE QUEST - SISTEMA DE PISTAS ===\n");
    printf("Montando o mapa da mans√£o com pistas...\n");
    
    // Cria a raiz - Hall de entrada
    Sala* hallEntrada = criarSala("Hall de Entrada", "Porta principal arrombada");
    
    // Cria salas do lado esquerdo com pistas
    Sala* salaEstar = criarSala("Sala de Estar", "Copo de vinho meio cheio na mesa");
    Sala* biblioteca = criarSala("Biblioteca", "Livro sobre venenos aberto na p√°gina 42");
    Sala* escritorio = criarSala("Escrit√≥rio Secreto", "Carta de amea√ßa na gaveta");
    
    // Cria salas do lado direito com pistas
    Sala* cozinha = criarSala("Cozinha", "Faca desaparecida do bloco de facas");
    Sala* jardim = criarSala("Jardim de Inverno", "Pegadas de barro levando √† janela");
    Sala* salaJogos = criarSala("Sala de Jogos", "Rel√≥gio quebrado marcando 21:47");
    
    // Monta a estrutura da √°rvore
    // Lado esquerdo
    hallEntrada->esquerda = salaEstar;
    salaEstar->esquerda = biblioteca;
    salaEstar->direita = escritorio;
    
    // Lado direito
    hallEntrada->direita = cozinha;
    cozinha->esquerda = jardim;
    cozinha->direita = salaJogos;
    
    // Inicializa a √°rvore BST de pistas (inicialmente vazia)
    PistaNode* arvorePistas = NULL;
    
    printf("Mapa montado com sucesso!\n");
    printf("Bem-vindo ao Detective Quest - Sistema de Pistas!\n");
    printf("Explore a mans√£o para coletar pistas e resolver o mist√©rio.\n");
    
    // Inicia a explora√ß√£o a partir do Hall de Entrada
    explorarSalasComPistas(hallEntrada, &arvorePistas);
    
    // Exibe todas as pistas coletadas em ordem alfab√©tica
    printf("\n=== CADERNO DE INVESTIGA√á√ÉO ===\n");
    printf("Pistas coletadas (ordenadas alfabeticamente):\n");
    
    if (arvorePistas == NULL) {
        printf("Nenhuma pista foi coletada durante a explora√ß√£o.\n");
    } else {
        exibirPistas(arvorePistas);
    }
    
    // Libera a mem√≥ria alocada
    liberarArvoreSalas(hallEntrada);
    liberarArvorePistas(arvorePistas);
    
    printf("\n=== FIM DO DETECTIVE QUEST ===\n");
    printf("Obrigado por jogar! Use as pistas coletadas para resolver o mist√©rio!\n");
    
    return 0;
}